#include "NetUdp.h"

void NetUdp::begin(uint16_t port){
  udp_.begin(port);
}

void NetUdp::loop(){
  if(millis()-lastRx_ > TIMEOUT_MS) carConnected_ = false;
  int n=udp_.parsePacket(); if(n<=0) return;
  static char buf[400];
  int len = udp_.read(buf, sizeof(buf)-1); if(len<=0) return; buf[len]=0;
  lastRx_=millis(); carConnected_=true; carIP_=udp_.remoteIP();
  if(DEBUG_MODE) DBG_PRINTF(3,"[CTRL] UDP %s: %s\n", carIP_.toString().c_str(), buf);
  if(onPkt_) onPkt_(buf);
}

void NetUdp::send(const String& s){
  if(!carIP_) return;
  udp_.beginPacket(carIP_, 4210);
  udp_.print(s);
  udp_.endPacket();
  if(DEBUG_MODE) DBG_PRINTF(3,"[CTRL] -> %s\n", s.c_str());
}
